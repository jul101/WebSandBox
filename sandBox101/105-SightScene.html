<!--
Create By    : yc_lin
Create Date  : 2015/10/20 上午 09:07
Project Name : WebSandBox
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sight Scene</title>
    <script src="../jQuery/jquery-1.11.3.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="../bootstrap/bootstrap-3.3.5-dist/css/bootstrap.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="../bootstrap/bootstrap-3.3.5-dist/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="../bootstrap/bootstrap-3.3.5-dist/js/bootstrap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script src="./js/105-SightScene.js" charset="utf-8"></script>
</head>
<body>
<style>
    .nodeIn,.nodeOut{
        border: solid thin black;
        cursor: pointer;
    }
    .unselectable {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: default;
    }
    .editor{
        display: inline-block;
    }
    .routeMasters{
        padding: 1em;
        /*height: 10%;*/
        /*background-color: red;*/
    }
    .routeDetail{
        padding: 1em 0;
        /*height: 10%;*/
        /*margin: auto -30px;*/
        /*background-color: green;*/
    }
    .inputArea{
        height: 20%;
    }
    #targetZone{
        height: 80%;
        /*background-color: gainsboro;*/
        overflow: scroll;
    }
    div.routeDetail div.input-group-btn button.shrinkPadding{
        padding: 0 5px;
    }
    body, html {
        height: 100%;
        overflow: hidden;
    }

</style>
<div class="container inputArea">
    <div class="row routeMasters">
        <button type="button" class="btn btn-default shrinkPadding" aria-label="Save" data-toggle="tooltip" data-placement="left" title="Save"><span class="glyphicon glyphicon-save-file"></span></button>
        <canvas style="display: none;"></canvas>
    </div>
    <div class="row routeMasters">
        <button class="btn btn-primary"  type="button">
            <div class="editor" contentEditable=true>花蓮好吃路線</div> <span class="badge">4</span>
        </button>
    </div>
    <div class="row routeDetail">
        <div class="col-md-2">
            <div class="input-group input-group-sm">
                <div class="input-group-btn prev">
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Transfer" data-toggle="tooltip" data-placement="top" title="Switch"><span class="glyphicon glyphicon-transfer"></span></button>
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Plus" data-toggle="tooltip" data-placement="top" title="Plus"><span class="glyphicon glyphicon-plus"></span></button>
                </div>
                <input type="text" class="form-control" aria-label="Text input with multiple buttons">
                <div class="input-group-btn next">
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Plus" data-toggle="tooltip" data-placement="top" title="Plus"><span class="glyphicon glyphicon-plus"></span></button>
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Transfer" data-toggle="tooltip" data-placement="top" title="Switch"><span class="glyphicon glyphicon-transfer"></span></button>
                </div>
            </div><!-- /.input-group -->
        </div><!-- /.col-lg-6 -->
        <div class="col-md-2">
            <div class="input-group input-group-sm">
                <div class="input-group-btn prev">
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Transfer" data-toggle="tooltip" data-placement="top" title="Switch"><span class="glyphicon glyphicon-transfer"></span></button>
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Plus" data-toggle="tooltip" data-placement="top" title="Plus"><span class="glyphicon glyphicon-plus"></span></button>
                </div>
                <input type="text" class="form-control" aria-label="Text input with multiple buttons">
                <div class="input-group-btn next">
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Plus" data-toggle="tooltip" data-placement="top" title="Plus"><span class="glyphicon glyphicon-plus"></span></button>
                    <button type="button" class="btn btn-default shrinkPadding" aria-label="Transfer" data-toggle="tooltip" data-placement="top" title="Switch"><span class="glyphicon glyphicon-transfer"></span></button>
                </div>
            </div><!-- /.input-group -->
        </div><!-- /.col-lg-6 -->
    </div><!-- /.row -->
</div>
<div id="targetZone" class="col-lg-12"></div>



</body>
</html>
<script>

    function bindEditorEvent(){

        function createTextNode(){
            var defaultGroupClass="col-md-2";
            var $group=$("<div>").addClass(defaultGroupClass);
            var $inputGroup=$('<div class="input-group input-group-sm">');
            var $inputGroupBtnPrev=$('<div class="input-group-btn prev">');
            var $inputGroupInput=$('<input type="text" class="form-control" aria-label="Text input with multiple buttons">');
            var $inputGroupBtnNext=$('<div class="input-group-btn next">');
            $inputGroup.append($inputGroupBtnPrev);
            $inputGroup.append($inputGroupInput);
            $inputGroup.append($inputGroupBtnNext);
            $group.append($inputGroup);
            console.log($group);
        };

        $('button[aria-label="Save"]').on('click',function(){
            var html = d3.select("svg")
                    .attr("width", $("svg").width())
                    .attr("height", $("svg").height())
                    .attr("version", 1.1)
                    .attr("xmlns", "http://www.w3.org/2000/svg")
                    .node().parentNode.innerHTML;

//            console.log(html);
            var imgsrc = 'data:image/svg+xml;base64,'+ btoa(html);
            var image = new Image;
            image.src = imgsrc;
            image.onload = function() {

                var canvas = document.querySelector("canvas");
                canvas.width = image.width;
                canvas.height = image.height;

                var context = canvas.getContext("2d");
                context.drawImage(image, 0, 0);
                var a = document.createElement("a");
                a.download = "sample.png";
                a.href = canvas.toDataURL("image/png");
                a.click();
            };
        });
        $('button[aria-label="Plus"]').on('click',function(){
            var inputGroupCls = ".input-group";
            var isPrev=$(this).closest(".input-group-btn").hasClass("prev");
            createTextNode();
        });

        $('button[aria-label="Transfer"]').on('click',function(){
            var inputGroupCls=".input-group";
            var isPrev=$(this).closest(".input-group-btn").hasClass("prev");
//            console.log('isPrev',isPrev);
            var $currentGroup=$(this).closest(inputGroupCls).parent();
            var $targetGroup;
            if(isPrev){
                $targetGroup = $currentGroup.prev();
                if($targetGroup&&$targetGroup.length===1)$currentGroup.insertBefore($targetGroup);
            }else{
                $targetGroup = $currentGroup.next();
                if($targetGroup&&$targetGroup.length===1)$targetGroup.insertBefore($currentGroup);
            }
        });

        $('[data-toggle="tooltip"]').tooltip();

        $(".editor").each(function(){
            var initContent;
            var currentContent;
            this.addEventListener('focus',function(){
                initContent = $(this).text();
            });
            this.addEventListener('blur',function(){
                currentContent = $(this).text();
                if(!currentContent){
                    currentContent = initContent;
                    $(this).text(initContent);
                }else{
                    currentContent = currentContent.trim();
                }
                $(this).text(currentContent);
            });
        });
    }

    var kkNode;
    $(document).ready(function(){
        var sceneAry=["Taipei","Hsinchu","Kaohsiung"];
        var sceneAry2=["Sydney","Australlia","Hsinchu","Tokyo"];
        var sceneAry3=["Canada","Hsinchu","Japan"];
        //createRoute(sceneAry,svg);
        var sightScene=new SightScene({
            targetZone:"#targetZone",
//            viewBox:"0 0 2000 500",
            width:'150%',
            height:'150%'
        });
        var route=sightScene.createRoute(sceneAry);
        var route2=sightScene.createRoute(sceneAry2);
        var route3=sightScene.createRoute(sceneAry3);
        console.log('route',route);
        bindEditorEvent();

    });
</script>
